<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Mentorship Connector</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
       body {
           font-family: 'Inter', sans-serif;
           background-color: #f3f4f6;
       }
       .card {
           transition: transform 0.3s ease, box-shadow 0.3s ease;
       }
       .card:hover {
           transform: translateY(-5px);
           box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
       }
       .swipe-card {
           width: 90%;
           max-width: 400px;
           height: 500px;
           background-color: white;
           border-radius: 1.5rem;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           display: flex;
           flex-direction: column;
           overflow: hidden;
           animation: fadeIn 0.5s ease-out;
       }
       @keyframes fadeIn {
           from { opacity: 0; transform: translate(-50%, -40%); }
           to { opacity: 1; transform: translate(-50%, -50%); }
       }
       .chat-container {
           flex-grow: 1;
           overflow-y: auto;
           display: flex;
           flex-direction: column-reverse;
           padding: 1rem;
       }
       .chat-message {
           max-width: 80%;
           margin-bottom: 0.5rem;
           padding: 0.5rem 1rem;
           border-radius: 1rem;
       }
       .modal-overlay {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0, 0, 0, 0.5);
           display: flex;
           justify-content: center;
           align-items: center;
       }
       .modal {
           background-color: white;
           padding: 2rem;
           border-radius: 1rem;
           text-align: center;
       }
   </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">


   <!-- Main Container -->
   <div id="app" class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
       <!-- Loading and Error Messages -->
       <div id="status" class="text-center text-gray-500 mb-4 hidden">
           <div id="loading-spinner" class="animate-spin h-8 w-8 text-blue-500 mx-auto hidden">
               <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
           </div>
           <p id="status-text" class="mt-2"></p>
       </div>


       <!-- App UI will be injected here -->
       <div id="content" class="flex flex-col items-center"></div>
   </div>
  
   <!-- Match Message Modal -->
   <div id="match-modal" class="modal-overlay hidden">
       <div class="modal">
           <h3 class="text-2xl font-bold mb-4">It's a Match! 🎉</h3>
           <p class="text-gray-600 mb-6">You and another user have liked each other's profiles!</p>
           <button id="close-modal-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition-colors duration-200">Start Chatting</button>
       </div>
   </div>


   <!-- Firebase Scripts -->
   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
       import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
       import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


       // IMPORTANT: These global variables are provided by the environment
       const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
  apiKey: "AIzaSyApkQJrJHsSRjd9tC2x21EdN_2IqWYKRxQ",
  authDomain: "wementor-app-cfce5.firebaseapp.com",
  projectId: "wementor-app-cfce5",
  storageBucket: "wementor-app-cfce5.firebasestorage.app",
  messagingSenderId: "31838724730",
  appId: "1:31838724730:web:3184b080194938a11751c3",
  measurementId: "G-5WRHES5F65"
};       const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


       // --- Firebase Initialization ---
       setLogLevel('debug');
       let app = null;
       let auth = null;
       let db = null;
       let storage = null; // New storage instance
       let userId = null;
       let appState = 'loading';
       let userProfile = null;
       let allUsers = [];
       let currentMatchIndex = 0;
       let matches = [];
       let selectedMatchId = null;
       let messages = [];


       const statusDiv = document.getElementById('status');
       const statusText = document.getElementById('status-text');
       const loadingSpinner = document.getElementById('loading-spinner');
       const contentDiv = document.getElementById('content');
       const matchModal = document.getElementById('match-modal');
       document.getElementById('close-modal-btn').addEventListener('click', () => {
           matchModal.classList.add('hidden');
       });


       // Function to show a loading state
       function showLoading(text) {
           statusDiv.classList.remove('hidden');
           loadingSpinner.classList.remove('hidden');
           statusText.textContent = text;
       }


       // Function to hide the loading state
       function hideLoading() {
           statusDiv.classList.add('hidden');
           loadingSpinner.classList.add('hidden');
           statusText.textContent = '';
       }


       // Function to show the match message modal
       function showMatchMessage() {
           matchModal.classList.remove('hidden');
       }


       // Initialize Firebase and set up auth listener
       async function initializeFirebase() {
           showLoading('Connecting to Firebase...');
           try {
               if (Object.keys(firebaseConfig).length > 0) {
                   app = initializeApp(firebaseConfig);
                   auth = getAuth(app);
                   db = getFirestore(app);
                   storage = getStorage(app); // Initialize Firebase Storage
                   await setPersistence(auth, browserLocalPersistence);


                   onAuthStateChanged(auth, async (user) => {
                       if (user) {
                           userId = user.uid;
                           await checkUserProfile();
                       } else {
                           if (initialAuthToken) {
                               await signInWithCustomToken(auth, initialAuthToken);
                           } else {
                               await signInAnonymously(auth);
                           }
                       }
                   });
               } else {
                   statusText.textContent = "Firebase config not provided. Cannot connect to database.";
               }
           } catch (e) {
               console.error("Error during Firebase initialization: ", e);
               statusText.textContent = "Error connecting to Firebase. Check console for details.";
           }
       }


       // Check if the user has a profile, if not, prompt for creation
       async function checkUserProfile() {
           showLoading('Checking your profile...');
           const profileRef = doc(db, `/artifacts/${appId}/public/data/profiles`, userId);
           const profileSnap = await getDoc(profileRef);
           if (profileSnap.exists()) {
               userProfile = profileSnap.data();
               appState = 'matching';
               listenForMatches();
               renderApp();
           } else {
               appState = 'createProfile';
               renderApp();
           }
       }
      
       // --- Firestore Listeners ---


       // Listen for new matches for the current user
       function listenForMatches() {
           if (!userId) return;
           const matchesRef = collection(db, `/artifacts/${appId}/public/data/matches`);
           const q = query(matchesRef, where('users', 'array-contains', userId));
           onSnapshot(q, (snapshot) => {
               matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
               renderApp();
           }, (error) => {
               console.error("Error listening to matches:", error);
           });
       }


       // Listen for messages in a specific conversation
       function listenForMessages(matchId) {
           if (!matchId) return;
           const messagesRef = collection(db, `/artifacts/${appId}/public/data/messages`);
           const q = query(messagesRef, where('matchId', '==', matchId));
           onSnapshot(q, (snapshot) => {
               messages = snapshot.docs.map(doc => doc.data()).sort((a, b) => a.timestamp - b.timestamp);
               renderApp();
               // Scroll to bottom of chat
               const chatContainer = document.getElementById('chat-container');
               if (chatContainer) {
                   chatContainer.scrollTop = chatContainer.scrollHeight;
               }
           }, (error) => {
               console.error("Error listening to messages:", error);
           });
       }
      
       // --- UI Rendering Functions ---


       function renderApp() {
           hideLoading();
           contentDiv.innerHTML = '';
          
           // Add header with user ID and nav
           const header = `
               <div class="w-full flex justify-between items-center mb-6">
                   <div class="text-sm text-gray-600 truncate">
                       <span class="font-semibold">User ID:</span> ${userId || 'N/A'}
                   </div>
                   ${userProfile ? `
                       <div class="flex space-x-2">
                           <button id="nav-matching" class="px-4 py-2 rounded-full font-semibold text-white transition-colors duration-200 ${appState === 'matching' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 hover:bg-gray-500'}">Matching</button>
                           <button id="nav-matches" class="px-4 py-2 rounded-full font-semibold text-white transition-colors duration-200 ${appState.startsWith('match') ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 hover:bg-gray-500'}">Matches (${matches.length})</button>
                       </div>
                   ` : ''}
               </div>
           `;
           contentDiv.innerHTML += header;
           document.getElementById('nav-matching')?.addEventListener('click', () => { appState = 'matching'; currentMatchIndex = 0; fetchUsers(); });
           document.getElementById('nav-matches')?.addEventListener('click', () => { appState = 'matchList'; renderApp(); });


           if (appState === 'loading') {
               showLoading('Authenticating...');
           } else if (appState === 'createProfile') {
               renderProfileCreation();
           } else if (appState === 'matching') {
               renderMatching();
           } else if (appState === 'matchList') {
               renderMatchList();
           } else if (appState === 'chat') {
               renderChat();
           }
       }


       // Renders the profile creation form
       function renderProfileCreation() {
           contentDiv.innerHTML = `
               <div class="bg-gray-50 p-8 rounded-2xl shadow-inner w-full max-w-lg text-center">
                   <h2 class="text-3xl font-bold text-gray-800 mb-6">Create Your Profile</h2>
                   <p class="text-gray-600 mb-8">Tell us about yourself to get started.</p>
                   <div class="space-y-4">
                       <input id="name-input" type="text" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                      
                       <div class="w-full">
                           <label for="role-select" class="block text-left text-sm font-medium text-gray-700 mb-2">I am a...</label>
                           <select id="role-select" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                               <option value="mentor">Mentor</option>
                               <option value="mentee">Mentee</option>
                           </select>
                       </div>


                       <div id="age-verification-section" class="w-full text-left hidden">
                           <label for="dob-input" class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                           <input id="dob-input" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                           <div id="age-display" class="mt-2 text-sm font-semibold text-gray-500"></div>
                           <div id="age-warning" class="mt-2 text-sm font-semibold text-red-500 hidden"></div>
                           <div id="mentee-guardian-option" class="mt-4 hidden">
                               <label class="inline-flex items-center">
                                   <input type="checkbox" id="guardian-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                                   <span class="ml-2 text-sm text-gray-700">I am a parent/guardian signing up a mentee under 18.</span>
                               </label>
                           </div>
                       </div>


                       <div class="w-full text-left">
                           <label for="headshot-input" class="block text-sm font-medium text-gray-700 mb-2">Upload Headshot (JPG/PNG)</label>
                           <input id="headshot-input" type="file" accept="image/jpeg,image/png" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                       </div>
                      
                       <div class="w-full text-left">
                           <label for="video-input" class="block text-sm font-medium text-gray-700 mb-2">Upload Short Video (MP4, 30-60s)</label>
                           <input id="video-input" type="file" accept="video/mp4,video/mov" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                       </div>


                       <textarea id="interests-textarea" placeholder="List your interests or what you're looking for (e.g., career advice, coding, design, project management)" class="w-full px-4 py-3 border border-gray-300 rounded-xl h-32 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                      
                       <button id="save-profile-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors duration-200" disabled>Save Profile</button>
                   </div>
               </div>
           `;
           const roleSelect = document.getElementById('role-select');
           const dobInput = document.getElementById('dob-input');
           const saveBtn = document.getElementById('save-profile-btn');
           const ageDisplay = document.getElementById('age-display');
           const ageWarning = document.getElementById('age-warning');
           const guardianOption = document.getElementById('mentee-guardian-option');
           const nameInput = document.getElementById('name-input');
           const interestsTextarea = document.getElementById('interests-textarea');
          
           // Show age verification section when a role is selected
           roleSelect.addEventListener('change', () => {
               document.getElementById('age-verification-section').classList.remove('hidden');
               validateForm();
           });


           // Re-validate form on change
           [nameInput, dobInput, interestsTextarea, roleSelect].forEach(el => {
               el.addEventListener('input', validateForm);
           });
           document.getElementById('guardian-checkbox').addEventListener('change', validateForm);


           // Function to validate the form and enable/disable the button
           function validateForm() {
               const name = nameInput.value;
               const interests = interestsTextarea.value;
               const role = roleSelect.value;
               const dob = dobInput.value;
              
               if (!name || !interests || !dob) {
                   saveBtn.disabled = true;
                   ageWarning.classList.add('hidden');
                   return;
               }


               const today = new Date();
               const birthDate = new Date(dob);
               let age = today.getFullYear() - birthDate.getFullYear();
               const m = today.getMonth() - birthDate.getMonth();
               if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                   age--;
               }
               ageDisplay.textContent = `Current Age: ${age}`;
               ageWarning.classList.add('hidden');
               guardianOption.classList.add('hidden');


               let isValid = true;
               if (role === 'mentor') {
                   if (age < 25) {
                       ageWarning.textContent = "Mentors must be at least 25 years old.";
                       ageWarning.classList.remove('hidden');
                       isValid = false;
                   }
               } else if (role === 'mentee') {
                   if (age < 18) {
                       guardianOption.classList.remove('hidden');
                       const isGuardian = document.getElementById('guardian-checkbox').checked;
                       if (!isGuardian) {
                           ageWarning.textContent = "A parent or guardian must sign up for a mentee under 18.";
                           ageWarning.classList.remove('hidden');
                           isValid = false;
                       }
                   }
               }
               saveBtn.disabled = !isValid;
           }


           document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
       }


       // Renders the card-based matching UI
       function renderMatching() {
           if (allUsers.length === 0 || currentMatchIndex >= allUsers.length) {
               contentDiv.innerHTML = `
                   <div class="text-center p-8 rounded-2xl bg-gray-50 shadow-inner max-w-md">
                       <h2 class="text-2xl font-bold mb-4 text-gray-800">No new ${userProfile.role === 'mentor' ? 'mentees' : 'mentors'} found.</h2>
                       <p class="text-gray-600">Check back later or adjust your profile interests to find more matches.</p>
                   </div>
               `;
               return;
           }


           const currentUser = allUsers[currentMatchIndex];
           const profileMedia = currentUser.headshotUrl ? `
               <img src="${currentUser.headshotUrl}" alt="Headshot" class="w-32 h-32 rounded-full object-cover mb-4">
           ` : `<div class="w-32 h-32 rounded-full bg-blue-200 flex items-center justify-center text-blue-800 font-bold text-5xl mb-4">${currentUser.name[0].toUpperCase()}</div>`;


           const videoSection = currentUser.videoUrl ? `
               <video src="${currentUser.videoUrl}" controls class="w-full rounded-xl mb-4"></video>
           ` : '';
          
           contentDiv.innerHTML = `
               <div class="swipe-card p-6 flex flex-col items-center">
                   ${profileMedia}
                   ${videoSection}
                   <h3 class="text-3xl font-bold text-gray-800 mb-2">${currentUser.name}</h3>
                   <p class="text-xl text-gray-600 font-medium capitalize mb-2">${currentUser.role}</p>
                   <p class="text-lg text-gray-500 mb-4">Age: ${currentUser.age}</p>
                   <p class="text-center text-gray-700 px-4 flex-grow overflow-y-auto mb-4">${currentUser.interests}</p>
                   <div class="flex space-x-6 mt-auto">
                       <button id="pass-btn" class="w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition-colors duration-200">
                           <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                       </button>
                       <button id="like-btn" class="w-16 h-16 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 transition-colors duration-200">
                           <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                       </button>
                   </div>
               </div>
           `;
           document.getElementById('pass-btn').addEventListener('click', () => { nextUser('pass'); });
           document.getElementById('like-btn').addEventListener('click', () => { nextUser('like'); });
       }


       // Renders the list of matched users
       function renderMatchList() {
           if (matches.length === 0) {
               contentDiv.innerHTML = `
                   <div class="text-center p-8 rounded-2xl bg-gray-50 shadow-inner w-full max-w-lg">
                       <h2 class="text-2xl font-bold mb-4 text-gray-800">You have no matches yet.</h2>
                       <p class="text-gray-600">Keep swiping to find your perfect match!</p>
                   </div>
               `;
               return;
           }
           contentDiv.innerHTML = `
               <div class="w-full max-w-lg">
                   <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Matches</h2>
                   <div id="matches-list" class="space-y-4">
                       ${matches.map(match => {
                           const matchedUserId = match.users.find(id => id !== userId);
                           const matchedUser = allUsers.find(user => user.id === matchedUserId);
                           if (!matchedUser) return '';
                           const userAvatar = matchedUser.headshotUrl ?
                               `<img src="${matchedUser.headshotUrl}" alt="Headshot" class="w-12 h-12 rounded-full object-cover mr-4">` :
                               `<div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center text-blue-800 font-bold text-xl mr-4">${matchedUser.name[0].toUpperCase()}</div>`;
                           return `
                               <div data-id="${match.id}" class="match-card flex items-center p-4 bg-gray-50 rounded-xl shadow-sm cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                                   ${userAvatar}
                                   <div class="flex-1">
                                       <p class="text-lg font-semibold text-gray-800">${matchedUser.name}</p>
                                       <p class="text-sm text-gray-500 capitalize">${matchedUser.role}</p>
                                   </div>
                                   <span class="text-xs text-gray-400">Match ID: ${match.id.substring(0, 5)}...</span>
                               </div>
                           `;
                       }).join('')}
                   </div>
               </div>
           `;
           document.querySelectorAll('.match-card').forEach(card => {
               card.addEventListener('click', () => {
                   selectedMatchId = card.dataset.id;
                   appState = 'chat';
                   listenForMessages(selectedMatchId);
                   renderApp();
               });
           });
       }


       // Renders the chat UI
       function renderChat() {
           const currentMatch = matches.find(m => m.id === selectedMatchId);
           if (!currentMatch) {
               appState = 'matchList';
               renderApp();
               return;
           }
           const matchedUserId = currentMatch.users.find(id => id !== userId);
           const matchedUser = allUsers.find(user => user.id === matchedUserId);
           if (!matchedUser) {
               appState = 'matchList';
               renderApp();
               return;
           }
           const userAvatar = matchedUser.headshotUrl ?
               `<img src="${matchedUser.headshotUrl}" alt="Headshot" class="w-10 h-10 rounded-full object-cover mr-4">` :
               `<div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-800 font-bold text-lg mr-2">${matchedUser.name[0].toUpperCase()}</div>`;


           contentDiv.innerHTML = `
               <div class="w-full max-w-lg flex flex-col h-[70vh] bg-gray-50 rounded-2xl shadow-inner">
                   <div class="flex items-center p-4 border-b border-gray-200 bg-white rounded-t-2xl">
                       <button id="back-to-matches-btn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 mr-4">
                           <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                       </button>
                       ${userAvatar}
                       <h3 class="text-lg font-bold text-gray-800">${matchedUser.name}</h3>
                   </div>
                  
                   <div id="chat-container" class="chat-container flex flex-col-reverse flex-1">
                       ${messages.map(msg => `
                           <div class="chat-message ${msg.senderId === userId ? 'bg-blue-500 text-white self-end' : 'bg-gray-200 text-gray-800 self-start'}">
                               ${msg.text}
                           </div>
                       `).join('')}
                   </div>
                  
                   <form id="message-form" class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
                       <div class="flex space-x-2">
                           <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                           <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition-colors duration-200">Send</button>
                       </div>
                   </form>
               </div>
           `;
           document.getElementById('back-to-matches-btn').addEventListener('click', () => { appState = 'matchList'; selectedMatchId = null; renderApp(); });
           document.getElementById('message-form').addEventListener('submit', sendMessage);
       }


       // --- Core App Logic Functions ---


       async function saveProfile() {
           showLoading('Saving profile...');
           const name = document.getElementById('name-input').value;
           const role = document.getElementById('role-select').value;
           const interests = document.getElementById('interests-textarea').value;
           const dob = document.getElementById('dob-input').value;
           const headshotFile = document.getElementById('headshot-input').files[0];
           const videoFile = document.getElementById('video-input').files[0];


           if (!name || !interests || !dob) {
               statusText.textContent = "Please fill in all fields.";
               hideLoading();
               return;
           }
          
           let profileData = { name, role, interests };


           const today = new Date();
           const birthDate = new Date(dob);
           let age = today.getFullYear() - birthDate.getFullYear();
           const m = today.getMonth() - birthDate.getMonth();
           if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
               age--;
           }


           profileData.age = age;


           // Handle headshot upload
           if (headshotFile) {
               showLoading('Uploading headshot...');
               const headshotRef = ref(storage, `artifacts/${appId}/public/images/headshots/${userId}_${headshotFile.name}`);
               await uploadBytes(headshotRef, headshotFile);
               profileData.headshotUrl = await getDownloadURL(headshotRef);
           }


           // Handle video upload
           if (videoFile) {
               showLoading('Uploading video...');
               const videoRef = ref(storage, `artifacts/${appId}/public/videos/${userId}_${videoFile.name}`);
               await uploadBytes(videoRef, videoFile);
               profileData.videoUrl = await getDownloadURL(videoRef);
           }


           const profileRef = doc(db, `/artifacts/${appId}/public/data/profiles`, userId);
           await setDoc(profileRef, profileData);
          
           userProfile = profileData;
           appState = 'matching';
           await fetchUsers();
           listenForMatches();
           renderApp();
       }


       async function fetchUsers() {
           showLoading('Finding matches...');
           const usersRef = collection(db, `/artifacts/${appId}/public/data/profiles`);
           const usersSnap = await getDocs(usersRef);
           allUsers = usersSnap.docs
               .map(doc => ({ id: doc.id, ...doc.data() }))
               .filter(user => user.id !== userId && user.role !== userProfile.role); // Only show opposite roles
           renderApp();
       }


       async function nextUser(action) {
           const swipedUserId = allUsers[currentMatchIndex].id;
          
           // Record the swipe
           const swipeRef = doc(db, `/artifacts/${appId}/public/data/swipes`, `${userId}_${swipedUserId}`);
           await setDoc(swipeRef, {
               swiperId: userId,
               swipedId: swipedUserId,
               action: action,
               timestamp: Date.now()
           });


           if (action === 'like') {
               await checkForMatch(swipedUserId);
           }


           currentMatchIndex++;
           renderApp();
       }


       async function checkForMatch(swipedUserId) {
           const oppositeSwipeRef = doc(db, `/artifacts/${appId}/public/data/swipes`, `${swipedUserId}_${userId}`);
           const oppositeSwipeSnap = await getDoc(oppositeSwipeRef);


           if (oppositeSwipeSnap.exists() && oppositeSwipeSnap.data().action === 'like') {
               // It's a match!
               const matchRef = doc(db, `/artifacts/${appId}/public/data/matches`, `${userId}_${swipedUserId}`);
               await setDoc(matchRef, {
                   users: [userId, swipedUserId],
                   createdAt: Date.now()
               });
               showMatchMessage();
           }
       }


       async function sendMessage(e) {
           e.preventDefault();
           const input = document.getElementById('message-input');
           const text = input.value.trim();
           if (text === '') return;


           const messagesRef = collection(db, `/artifacts/${appId}/public/data/messages`);
           await addDoc(messagesRef, {
               matchId: selectedMatchId,
               senderId: userId,
               text: text,
               timestamp: Date.now()
           });
           input.value = '';
       }


       // --- Start the App ---
       initializeFirebase();
   </script>
</body>

</html>
